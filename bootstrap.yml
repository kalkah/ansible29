---

- hosts: all
  become: true
  tasks:
  - name: Update Repository Index
    apt:
      update_cache: yes
 
  - name: Add admin to the primary group
    group:
      name: admin1
      state: present

  - name: Add admin to the secondary group
    group:
      name: "{{ item }}"
      state: present
    loop:
      - sudo
      - adm
      - root


  - name: Create admin user
    user:
      name: admin
      group: admin1
      groups: sudo,adm,root

  - name: Add a sudoer file for admin
    copy:
      src: sudoer_admin
      dest: /etc/sudoers.d/admin
      owner: root
      group: root
      mode: 0440

  - name: Add Ansible SSH key to each node authorized_keys
    authorized_key:
      user: "{{ ansible_user }}"
      key: "{{ lookup('file', '~/.ssh/ansible.pub') }}"
      state: present
